name: "Multimodule Releaser"
description: "Releases packages in a multimodule repository"
inputs:
  module:
    description: "ë°°í¬í•˜ê³ ì í•˜ëŠ” ëª¨ë“ˆ ëª…"
    required: true
  bump:
    description: "next tagì—ì„œ SemVer ì–´ë–¤ ë¶€ë¶„(major, minor, patch)ë¥¼ ì˜¬ë¦´ì§€ ê²°ì •"
    default: "patch"
    required: false
  divider:
    description: "Tagì˜ Prefixì™€ Version ì‚¬ì´ì— ë“¤ì–´ê°ˆ êµ¬ë¶„ì"
    default: "-"
    required: false
outputs:
  next-tag:
    description: "ë‹¤ìŒ Tag ëª… (eg. sample-service-v1.0.1)"
    value: ${{ steps.get-tag.outputs.next-tag }}
  current-tag:
    description: "í˜„ì¬ Tag ëª… (eg. sample-service-v1.0.0)"
    value: ${{ steps.get-tag.outputs.current-tag }}
  next-version:
    description: "ë‹¤ìŒ Version (eg. 1.0.1)"
    value: ${{ steps.get-tag.outputs.next-version }}
  current-version:
    description: "í˜„ì¬ Version (eg. 1.0.0)"
    value: ${{ steps.get-tag.outputs.current-version }}
  changelog:
    description: "ìƒì„±ë  íƒœê·¸ì— ëŒ€í•œ Changelog"
    value: ${{ steps.changelog.outputs.changelog }}
  
runs:
  using: composite
  steps:
    - name: Get Tags
      id: get-tag
      uses: bucketplace/ci/.github/actions/latest-tag-finder@latest
      with:
        prefix: '${{ inputs.module }}${{ inputs.divider }}'
        bump: '${{ github.event.inputs.bump }}'
    - name: Build Changelog
      id: changelog
      uses: mikepenz/release-changelog-builder-action@v3
      with:
        configurationJson: |
          {
            "categories": [
              {
                "title": "## ğŸš€ Features",
                "labels": ["feature", "module/${{ inputs.module }}"],
                "exhaustive": true
              },
              {
                "title": "## ğŸ› Bug Fixes",
                "labels": ["bugfix", "module/${{ inputs.module }}"],
                "exhaustive": true
              },
              {
                "title": "## ğŸ§ª Tests",
                "labels": ["test", "module/${{ inputs.module }}"],
                "exhaustive": true
              },
              {
                "title": "## ğŸ“¦ Dependencies",
                "labels": ["dependencies", "module/${{ inputs.module }}"],
                "exhaustive": true
              },
              {
                "title": "## ğŸ’¬ Others",
                "labels": ["module/${{ inputs.module }}"],
                "exclude_labels": ["feature", "bugfix", "test", "dependencies"]
              }
            ],
            "template": "#{{CHANGELOG}}",
            "pr_template": "- #{{TITLE}} @#{{AUTHOR}}\n   - PR: ##{{NUMBER}}",
            "empty_template": "- no changes"
          }
        fromTag: ${{ steps.get-tag.outputs.current-tag }}
        toTag: ${{ github.ref }}
    - name: print changelog 
      run: |
        cat  <<EOF >> $GITHUB_STEP_SUMMARY
        # Version
        ${{ steps.get-tag.outputs.next-tag }}
        # Changelog
        ${{ steps.changelog.outputs.changelog }}
        EOF
      shell: bash
